name: Pre-commit autoupdate

on:
  workflow_dispatch:
  schedule:
    # Weekly on Mondays at 09:00 UTC
    - cron: "0 9 * * 1"

# Default to least-privilege at workflow level
permissions:
  contents: read

jobs:
  autoupdate:
    runs-on: ubuntu-latest

    # Only this job needs write perms (to push a branch + open PR)
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check out repo
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: "3.11"

      - name: Install pre-commit
        run: |
          python -m pip install --no-cache-dir --require-hashes -r requirements-ci.txt

      - name: Update pre-commit hooks
        run: |
          pre-commit autoupdate

      - name: Run pre-commit (all files)
        run: |
          pre-commit run --all-files

      - name: Create pull request
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8
        with:
          branch: chore/pre-commit-autoupdate
          delete-branch: true
          title: "chore: pre-commit autoupdate"
          commit-message: "chore: pre-commit autoupdate"
          body: |
            This PR was created automatically by the scheduled workflow.

            It runs `pre-commit autoupdate` to bump hook revisions in `.pre-commit-config.yaml`
            and then executes `pre-commit run --all-files` to verify hooks still pass.
          labels: |
            dependencies
            automated
