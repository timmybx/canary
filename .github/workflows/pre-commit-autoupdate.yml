name: Pre-commit autoupdate

on:
  workflow_dispatch:
  schedule:
    # Weekly on Mondays at 09:00 UTC
    - cron: "0 9 * * 1"

# Default to least-privilege at workflow level
permissions:
  contents: read

jobs:
  autoupdate:
    runs-on: ubuntu-latest

    # Only this job needs write perms (to push a branch + open PR)
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check out repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.11"

      - name: Install pre-commit
        run: |
          python -m pip install --no-cache-dir --require-hashes -r requirements-ci.txt

      - name: Update pre-commit hooks
        run: |
          pre-commit autoupdate

      - name: Run pre-commit (all files)
        run: |
          pre-commit run --all-files

      - name: Create pull request
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8
        with:
          branch: chore/pre-commit-autoupdate
          delete-branch: true
          title: "chore: pre-commit autoupdate"
          commit-message: "chore: pre-commit autoupdate"
          body: |
            This PR was created automatically by the scheduled workflow.

            It runs `pre-commit autoupdate` to bump hook revisions in `.pre-commit-config.yaml`
            and then executes `pre-commit run --all-files` to verify hooks still pass.
          labels: |
            dependencies
            automated
